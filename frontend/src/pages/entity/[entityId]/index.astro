---
import BaseLayout from "@/layouts/BaseLayout.astro";
import { loadBudgetData, getManifest } from "@/lib/data-loader";
import { formatCurrency } from "@/lib/format";
import BudgetExplorer from "@/components/BudgetExplorer";
import type { BudgetData } from "@/lib/types";

export async function getStaticPaths() {
  const manifest = getManifest();
  return manifest.entities
    .filter((e) => e.status === "active")
    .map((entity) => ({
      params: { entityId: entity.id },
      props: { entity },
    }));
}

const { entityId } = Astro.params;
const { entity } = Astro.props;

// Load budget data for all available years
const budgetDataByYear: Record<string, BudgetData> = {};
for (const year of entity.available_years) {
  budgetDataByYear[year] = await loadBudgetData(entityId, year);
}

// Use default year for metadata
const defaultData = budgetDataByYear[entity.default_year];
---

<BaseLayout
  title={`${entity.name} Budget`}
  description={`Explore the ${entity.name} ${defaultData.metadata.fiscal_year_label} budget of ${formatCurrency(defaultData.metadata.total_appropriations)}`}
>
  <BudgetExplorer
    entityId={entityId}
    entityName={entity.name}
    budgetDataByYear={budgetDataByYear}
    availableYears={entity.available_years}
    defaultYear={entity.default_year}
    client:load
  />
</BaseLayout>
