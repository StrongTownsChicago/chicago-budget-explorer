---
import BaseLayout from "@/layouts/BaseLayout.astro";
import { loadBudgetData, getManifest } from "@/lib/data-loader";
import SimulatorPanel from "@/components/simulator/SimulatorPanel";
import type { BudgetData } from "@/lib/types";

export async function getStaticPaths() {
  const manifest = getManifest();
  return manifest.entities
    .filter((e) => e.status === "active")
    .map((entity) => ({
      params: { entityId: entity.id },
      props: { entity },
    }));
}

const { entityId } = Astro.params;
const { entity } = Astro.props;

// Load budget data for all available years (same pattern as entity overview page)
const budgetDataByYear: Record<string, BudgetData> = {};
for (const year of entity.available_years) {
  budgetDataByYear[year] = await loadBudgetData(entityId, year);
}
---

<BaseLayout
  title={`${entity.name} Budget Simulator`}
  description={`Adjust ${entity.name}'s budget and see how it affects the total. Try to keep it balanced!`}
>
  <!-- Page Header -->
  <section class="gradient-hero text-white -mx-4 -mt-8 px-4 py-10 mb-8">
    <div class="max-w-4xl mx-auto">
      <h1 class="text-4xl font-extrabold tracking-tight">Budget Simulator</h1>
      <p class="text-lg text-white/80 mt-2">
        Adjust department budgets to see how it affects the total. Try to keep it balanced!
      </p>
      <a
        href={`/entity/${entityId}`}
        class="inline-block mt-4 text-white/70 hover:text-white transition-colors"
      >
        &larr; Back to {entity.name} Overview
      </a>
    </div>
  </section>

  <div class="max-w-4xl mx-auto">
    <!-- Simulator -->
    <SimulatorPanel
      budgetDataByYear={budgetDataByYear}
      availableYears={entity.available_years}
      defaultYear={entity.default_year}
      client:load
    />

    <!-- Instructions -->
    <div class="mt-8 card p-5">
      <h3 class="font-semibold text-gray-900 mb-2">How to use the simulator:</h3>
      <ul class="list-disc list-inside text-sm text-gray-700 space-y-1">
        <li>Use the sliders to increase or decrease each department's budget</li>
        <li>Watch the budget balance indicator update in real-time</li>
        <li>Green = balanced, Red = over budget, Yellow = under budget</li>
        <li>Locked departments cannot be adjusted (usually debt service or legal obligations)</li>
        <li>Click "Reset All" to restore the original budget</li>
      </ul>
    </div>

    <!-- Disclaimer -->
    <div class="mt-6 p-5 bg-amber-50 border border-amber-200 rounded-xl">
      <h4 class="font-semibold text-amber-900 mb-2">Important Note</h4>
      <p class="text-sm text-amber-800">
        This is a simplified simulation for educational purposes. Real municipal budgeting
        involves complex legal constraints, multi-year planning, public input processes,
        and detailed line-item decisions. Changes to the budget require City Council approval
        and must comply with state law.
      </p>
    </div>
  </div>
</BaseLayout>
