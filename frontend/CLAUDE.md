# Frontend Context for AI Agents

## Overview

Astro 5 + React 19 static site for the Chicago Budget Explorer. Displays budget data with interactive charts and simulator. Ships minimal JavaScript by default (islands architecture).

## Quick Reference

**Dev server**: `npm run dev` (http://localhost:4321)
**Build**: `npm run build`
**Test**: `npm test`
**Lint**: `npm run lint`

## Architecture

### Islands Architecture

**Astro**: Static HTML generation. Components are server-rendered by default (no JS).

**React Islands**: Interactive components hydrate on-demand with `client:*` directives.

```astro
<!-- Static (no JS shipped) -->
<Header />

<!-- Hydrates when visible -->
<DepartmentBar data={departments} client:visible />

<!-- Hydrates immediately -->
<SimulatorPanel data={data} client:load />

<!-- Hydrates when browser idle -->
<BudgetTreemap data={departments} client:idle />
```

### Data Flow

```
Static JSON → data-loader.ts → Astro page → React components (if interactive)
```

Data is loaded at **build time** (static), not runtime. JSON files in `src/data/` are generated by pipeline.

## File Organization

```
frontend/src/
├── data/                      # Generated JSON (from pipeline)
│   ├── manifest.json
│   └── city-of-chicago/
│       ├── fy2026.json
│       ├── fy2025.json
│       ├── fy2024.json
│       └── fy2023.json
├── lib/                       # Utilities (pure functions)
│   ├── types.ts               # TypeScript types matching JSON schema
│   ├── data-loader.ts         # Load JSON files
│   ├── simulation-engine.ts   # Pure simulation logic
│   ├── format.ts              # Currency/percent formatting
│   └── colors.ts              # Color palette
├── components/                # Astro and React components
│   ├── BudgetExplorer.tsx     # Main budget explorer with year selection
│   ├── BudgetSummary.tsx      # Budget overview with metadata
│   ├── layout/                # Header, Footer (Astro)
│   ├── charts/                # Recharts + D3 components (React)
│   │   ├── EntityPicker.tsx   # Entity selector
│   │   ├── DepartmentBar.tsx  # Department spending bar chart
│   │   ├── FundPie.tsx        # Fund breakdown pie chart
│   │   ├── BudgetTreemap.tsx  # D3 treemap visualization
│   │   ├── TrendChart.tsx     # Historical budget trends
│   │   ├── RevenueBreakdown.tsx      # Revenue sources
│   │   ├── RevenueVsSpending.tsx     # Revenue vs spending comparison
│   │   ├── AppropriationBreakdown.tsx # Appropriations breakdown
│   │   └── TransparencyCallout.tsx   # Data quality callout
│   ├── simulator/             # Simulator components (React)
│   └── ui/                    # Shared UI components (YearSelector)
├── layouts/
│   └── BaseLayout.astro       # Page wrapper with header/footer
├── pages/                     # Routes (file-based routing)
│   ├── index.astro            # Landing page
│   ├── about.astro            # About page
│   └── entity/
│       └── [entityId]/
│           ├── index.astro    # Entity overview (charts)
│           └── simulate.astro # Simulator page
└── styles/
    └── global.css             # Tailwind + custom styles
```

## Common Tasks

### Add a New Page

1. Create `.astro` file in `src/pages/`
2. Use `BaseLayout` wrapper
3. Add navigation link in `BaseLayout.astro`

### Add a New Chart Component

1. Create React component in `src/components/charts/`
2. Use Recharts or D3
3. Import in page with `client:visible` directive
4. Export `interface Props` for type safety

### Update Data

1. Run pipeline: `cd pipeline && make all`
2. Pipeline copies JSON to `frontend/src/data/`
3. Rebuild frontend: `npm run build`

### Debug Hydration Issues

**Symptom**: onClick doesn't work
**Fix**: Missing `client:*` directive. Add `client:load` or `client:visible`.

**Symptom**: "Cannot use import statement outside a module"
**Fix**: Component has browser-only code. Wrap in `client:only` or check for `window`.

## Key Patterns

### Loading Data in Astro Pages

```astro
---
import { loadBudgetData } from "@/lib/data-loader";

const data = await loadBudgetData("city-of-chicago", "fy2025");
---

<BaseLayout title="Budget">
  <!-- Use data here -->
</BaseLayout>
```

### React Component Pattern

```tsx
import type { Department } from "@/lib/types";

export interface Props {
  department: Department;
}

export default function DepartmentCard({ department }: Props) {
  return <div>{department.name}</div>;
}
```

### Simulation State Management

Use `useState` in React components. Simulation engine is pure functions:

```tsx
import { useState } from "react";
import { createSimulation, adjustDepartment } from "@/lib/simulation-engine";

const [state, setState] = useState(() => createSimulation(data));

const handleAdjust = (deptId: string, multiplier: number) => {
  setState((prev) => adjustDepartment(prev, departments, deptId, multiplier));
};
```

## Styling

**Tailwind CSS 4**: Utility-first styling.

**Custom colors**: `bg-chicago-blue`, `text-chicago-red` (defined in `src/styles/global.css` via Tailwind 4 `@theme`).

**Responsive**: Mobile-first. Use `md:`, `lg:` prefixes for breakpoints.

```astro
<div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
  <!-- Stacks on mobile, 2 cols on tablet, 3 cols on desktop -->
</div>
```

## Type Safety

**TypeScript strict mode**: Enabled. All code must type-check.

**Types derive from JSON**: `src/lib/types.ts` mirrors pipeline's Pydantic models.

**Path aliases**: `@/lib/types` → `src/lib/types` (configured in `tsconfig.json`).

**Astro type checking**: Run `npm run build` which includes `astro check`.

## Testing

**Vitest**: Unit tests for utilities (simulation engine, formatting).

**Testing Library**: Component tests for complex interactions.

**Run tests**: `npm test`

**Pattern**:
```typescript
import { describe, it, expect } from "vitest";

describe("formatCurrency", () => {
  it("formats large amounts with suffixes", () => {
    expect(formatCurrency(1500000000)).toBe("$1.5B");
  });
});
```

## Performance

**Islands architecture**: Only interactive components load JS.

**Code splitting**: Each entity's JSON loads on-demand.

**Lazy loading**: Charts use `client:visible` to load when scrolled into view.

**Target**: Lighthouse score ≥90 (desktop), ≥75 (mobile).

## Accessibility

**Semantic HTML**: `<nav>`, `<main>`, `<footer>`, `<section>`.

**ARIA labels**: All interactive elements labeled.

**Keyboard navigation**: Sliders work with arrow keys.

**Skip link**: "Skip to main content" for screen readers.

**Color contrast**: WCAG AA (4.5:1 ratio).

**Reduced motion**: Respects `prefers-reduced-motion` media query.

## Gotchas

1. **Astro components don't have access to browser APIs**: Use `client:only` or React components
2. **React islands don't share state**: Each island is independent
3. **JSON imports need `resolveJsonModule: true`**: Already in tsconfig.json
4. **Tailwind purges unused classes**: Don't use dynamic class names (use `classNames` helper)
5. **Recharts needs explicit height**: Use `<ResponsiveContainer height={400}>`

## Where to Look

**Types**: `src/lib/types.ts` (should match pipeline schema)
**Simulation logic**: `src/lib/simulation-engine.ts` (pure functions)
**Formatting**: `src/lib/format.ts` (currency, percents)
**Data loading**: `src/lib/data-loader.ts`
**Base layout**: `src/layouts/BaseLayout.astro` (header, footer)
**Routing**: `src/pages/` (file-based routing)

## Dependencies

- `astro`: Static site generator
- `react`: Interactive components
- `recharts`: Standard charts (bar, pie)
- `d3`: Custom visualizations (treemap)
- `tailwindcss`: Styling
- `vitest`: Testing

## Deployment

**Cloudflare Pages** (automatic):
- Push to `main` → production
- Pull requests → preview deployments

**Build command**: `npm run build`
**Output**: `dist/`

## Contact/Issues

For type errors, check `src/lib/types.ts` matches pipeline schema.

For hydration issues, verify `client:*` directives are present.

For performance issues, check bundle size with `npx vite-bundle-visualizer`.
